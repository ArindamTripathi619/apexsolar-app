# ApexSolar - Secure IP-Based Deployment Guide

This guide will help you deploy ApexSolar securely on your remote VM using IP address access with HTTPS.

## ðŸš€ Quick Deploy

### Option 1: Automated Deployment (Recommended)

Run the deployment script on your VM:

```bash
# Make the deployment script executable
chmod +x deploy.sh

# Run the deployment script
sudo ./deploy.sh
```

This script will:
- Install all required dependencies (Docker, Nginx, etc.)
- Generate SSL certificates for your IP address
- Configure secure Nginx reverse proxy
- Set up firewall rules
- Deploy the application with Docker Compose
- Configure monitoring and log rotation

### Option 2: Manual Deployment

If you prefer to deploy manually, follow these steps:

#### 1. Prerequisites

```bash
# Update system
sudo apt update && sudo apt upgrade -y

# Install required packages
sudo apt install -y curl wget git nginx docker.io docker-compose ufw openssl

# Start services
sudo systemctl start docker nginx
sudo systemctl enable docker nginx

# Add user to docker group
sudo usermod -aG docker $USER
newgrp docker
```

#### 2. Application Setup

```bash
# Create application directory
sudo mkdir -p /opt/apexsolar-app
sudo chown $USER:$USER /opt/apexsolar-app
cd /opt/apexsolar-app

# Clone your repository or copy files
# git clone https://github.com/ArindamTripathi619/apexsolar-app.git .

# Create uploads directory
mkdir -p uploads/{employees,invoices,challans}
chmod 755 uploads uploads/{employees,invoices,challans}
```

#### 3. SSL Certificate Generation

```bash
# Get your server IP
SERVER_IP=$(curl -s ifconfig.me)

# Generate SSL certificate for IP
sudo mkdir -p /etc/ssl/{certs,private}
sudo openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
    -keyout /etc/ssl/private/apexsolar.key \
    -out /etc/ssl/certs/apexsolar.crt \
    -subj "/C=IN/ST=State/L=City/O=ApexSolar/OU=IT/CN=$SERVER_IP" \
    -addext "subjectAltName=IP:$SERVER_IP"

sudo chmod 600 /etc/ssl/private/apexsolar.key
sudo chmod 644 /etc/ssl/certs/apexsolar.crt
```

#### 4. Nginx Configuration

```bash
# Create Nginx configuration
sudo cp nginx.conf /etc/nginx/sites-available/apexsolar

# Update the configuration with your IP
sudo sed -i "s/YOUR_SERVER_IP/$SERVER_IP/g" /etc/nginx/sites-available/apexsolar

# Enable the site
sudo ln -sf /etc/nginx/sites-available/apexsolar /etc/nginx/sites-enabled/
sudo rm -f /etc/nginx/sites-enabled/default

# Test and reload
sudo nginx -t
sudo systemctl reload nginx
```

#### 5. Firewall Setup

```bash
# Configure firewall
sudo ufw --force enable
sudo ufw allow ssh
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw allow from 127.0.0.1 to any port 3000
```

#### 6. Application Deployment

```bash
# Build and start the application
docker-compose -f docker-compose.prod.yml build --no-cache
docker-compose -f docker-compose.prod.yml up -d

# Setup database
sleep 30
docker-compose -f docker-compose.prod.yml exec -T app npx prisma db push
docker-compose -f docker-compose.prod.yml exec -T app npx prisma db seed
```

## ðŸ”§ GitHub Actions Setup

To enable automatic deployment from your laptop, configure these GitHub Secrets in your repository:

### Required Secrets

Go to your GitHub repository â†’ Settings â†’ Secrets and variables â†’ Actions, and add:

#### Server Connection
- `HOST`: Your VM's public IP address
- `USERNAME`: SSH username (usually `root` or `ubuntu`)
- `SSH_KEY`: Your private SSH key content
- `PORT`: SSH port (usually `22`)

#### Database Configuration
- `DB_USER`: `apexsolar`
- `DB_PASSWORD`: Strong random password (generated by deployment script)
- `DB_NAME`: `apexsolar`

#### Application Security
- `JWT_SECRET`: 64-character random string (generated by deployment script)
- `NEXTAUTH_SECRET`: 64-character random string (generated by deployment script)
- `NEXTAUTH_URL`: `https://YOUR_SERVER_IP`

#### Admin Credentials
- `ADMIN_EMAIL`: `admin@apexsolar.net`
- `ADMIN_PASSWORD`: `admin123` (change after first login)

### SSH Key Setup

1. Generate SSH key on your laptop (if you don't have one):
```bash
ssh-keygen -t rsa -b 4096 -C "your-email@example.com"
```

2. Copy public key to your server:
```bash
ssh-copy-id username@your-server-ip
```

3. Add private key content to GitHub Secrets as `SSH_KEY`

## ðŸ“± Accessing the Application

After deployment, you can access:

- **Main Application**: `https://YOUR_SERVER_IP`
- **Admin Dashboard**: `https://YOUR_SERVER_IP/admin`
- **Attendance Portal**: `https://YOUR_SERVER_IP/attendance`
- **Health Check**: `https://YOUR_SERVER_IP/api/health`

### Default Login Credentials

- **Admin**: `admin@apexsolar.net` / `admin123`
- **Accountant**: `accountant@apexsolar.net` / `accountant123`

**âš ï¸ IMPORTANT: Change these passwords immediately after first login!**

## ðŸ›¡ï¸ Security Features

### SSL/HTTPS
- Self-signed SSL certificate for IP address
- HTTPS enforced (HTTP redirects to HTTPS)
- Modern TLS configuration (TLS 1.2+)

### Security Headers
- X-Frame-Options: DENY
- X-Content-Type-Options: nosniff
- X-XSS-Protection: 1; mode=block
- Strict-Transport-Security (HSTS)
- Referrer-Policy: strict-origin-when-cross-origin

### Firewall
- Only necessary ports open (22, 80, 443)
- Application port (3000) restricted to localhost
- UFW configured and enabled

### Application Security
- JWT tokens in HTTP-only cookies
- BCrypt password hashing
- Role-based access control
- File upload validation
- SQL injection prevention

## ðŸ“Š Monitoring & Management

### Application Status
```bash
# Check application status
docker-compose -f docker-compose.prod.yml ps

# View application logs
docker-compose -f docker-compose.prod.yml logs -f app

# Restart application
docker-compose -f docker-compose.prod.yml restart app
```

### System Monitoring
```bash
# Check Nginx status
sudo systemctl status nginx

# View Nginx logs
sudo tail -f /var/log/nginx/apexsolar.access.log
sudo tail -f /var/log/nginx/apexsolar.error.log

# Check firewall status
sudo ufw status verbose
```

### Database Management
```bash
# Access database
docker-compose -f docker-compose.prod.yml exec postgres psql -U apexsolar -d apexsolar

# Backup database
docker-compose -f docker-compose.prod.yml exec postgres pg_dump -U apexsolar apexsolar > backup_$(date +%Y%m%d_%H%M%S).sql

# Restore database
docker-compose -f docker-compose.prod.yml exec -T postgres psql -U apexsolar apexsolar < backup_file.sql
```

## ðŸš¨ SSL Certificate Warning

Since we're using a self-signed certificate for IP access, browsers will show a security warning. This is expected behavior. You can:

1. **Accept the warning** and proceed (safe for internal use)
2. **Add exception** in your browser for the IP address
3. **Import the certificate** into your browser's trusted certificates

For production with a domain name, use Let's Encrypt certificates instead.

## ðŸ”„ Automatic Deployment

Once GitHub Actions is configured:

1. Make changes to your code locally
2. Commit and push to the `main` branch
3. GitHub Actions will automatically:
   - Run tests
   - Build Docker image
   - Deploy to your server
   - Run database migrations

## âš¡ Performance Optimization

The deployment includes:
- Nginx reverse proxy with caching
- Docker image optimization
- Database connection pooling
- Static file serving optimization
- Log rotation for disk space management

## ðŸ†˜ Troubleshooting

### Application Won't Start
```bash
# Check logs
docker-compose -f docker-compose.prod.yml logs app

# Restart services
docker-compose -f docker-compose.prod.yml down
docker-compose -f docker-compose.prod.yml up -d
```

### SSL Certificate Issues
```bash
# Regenerate certificate
sudo openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
    -keyout /etc/ssl/private/apexsolar.key \
    -out /etc/ssl/certs/apexsolar.crt \
    -subj "/C=IN/ST=State/L=City/O=ApexSolar/OU=IT/CN=$(curl -s ifconfig.me)" \
    -addext "subjectAltName=IP:$(curl -s ifconfig.me)"

sudo systemctl reload nginx
```

### Database Connection Issues
```bash
# Reset database
docker-compose -f docker-compose.prod.yml down -v
docker-compose -f docker-compose.prod.yml up -d
sleep 30
docker-compose -f docker-compose.prod.yml exec -T app npx prisma db push
docker-compose -f docker-compose.prod.yml exec -T app npx prisma db seed
```

## ðŸ“ž Support

For issues or questions:
1. Check the application logs
2. Review this deployment guide
3. Verify all GitHub Secrets are correctly configured
4. Ensure your server meets the system requirements

---

**ðŸŽ‰ Your ApexSolar application is now securely deployed and accessible via HTTPS on your server IP!**
